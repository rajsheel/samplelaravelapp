name: Deploy Laravel Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: infrastructure
        run: |
          npm install
          npm install -g aws-cdk

      - name: Set environment variables
        run: |
          echo "CDK_DEFAULT_ACCOUNT=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "CDK_DEFAULT_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          
          # Generate a random APP_KEY if not provided
          if [ -z "${{ secrets.APP_KEY }}" ]; then
            echo "APP_KEY=$(openssl rand -base64 32)" >> $GITHUB_ENV
          else
            echo "APP_KEY=${{ secrets.APP_KEY }}" >> $GITHUB_ENV
          fi
          
          # Display environment variables (without sensitive values)
          echo "Environment variables set:"
          echo "CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION }}"
          echo "ENVIRONMENT: ${{ github.event.inputs.environment }}"
          echo "DB_USERNAME: ${{ secrets.DB_USERNAME }}"
          echo "APP_KEY: [REDACTED]"

      - name: Create and verify AWS Parameter Store parameters
        run: |
          # Create the parameter with the correct path based on environment
          PARAM_NAME="/${CDK_DEFAULT_ACCOUNT}/prod/APP_KEY"
          echo "Creating parameter: $PARAM_NAME"
          
          aws ssm put-parameter \
            --name "$PARAM_NAME" \
            --value "$APP_KEY" \
            --type "String" \
            --overwrite
          
          # Verify parameter was created
          echo "Verifying parameter exists..."
          aws ssm get-parameter --name "$PARAM_NAME" --with-decryption
          
          # List parameters to confirm
          echo "Listing parameters in path: /${CDK_DEFAULT_ACCOUNT}/prod/"
          aws ssm get-parameters-by-path --path "/${CDK_DEFAULT_ACCOUNT}/prod/" --recursive
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CDK_DEFAULT_ACCOUNT: ${{ env.CDK_DEFAULT_ACCOUNT }}
          APP_KEY: ${{ env.APP_KEY }}

      - name: Bootstrap CDK environment
        working-directory: infrastructure
        run: |
          echo "Bootstrapping CDK environment..."
          npm run bootstrap -- --require-approval never
          
          # Verify bootstrap completed
          echo "Verifying bootstrap status..."
          aws cloudformation describe-stacks --stack-name CDKToolkit --query 'Stacks[0].StackStatus' --output text
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CDK_DEFAULT_ACCOUNT: ${{ env.CDK_DEFAULT_ACCOUNT }}
          CDK_DEFAULT_REGION: ${{ env.CDK_DEFAULT_REGION }}

      - name: Build and push Docker images
        run: |
          # Login to ECR
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
          
          # Build and push PHP-FPM image
          docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/laravel-app:${{ github.sha }} .
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/laravel-app:${{ github.sha }}
          
          # Build and push Nginx image
          docker build -f nginx.Dockerfile -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/laravel-nginx:${{ github.sha }} .
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/laravel-nginx:${{ github.sha }}

      - name: Deploy infrastructure
        working-directory: infrastructure
        run: |
          echo "Deploying infrastructure..."
          npm run deploy -- --require-approval never
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CDK_DEFAULT_ACCOUNT: ${{ env.CDK_DEFAULT_ACCOUNT }}
          CDK_DEFAULT_REGION: ${{ env.CDK_DEFAULT_REGION }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Update ECS service
        run: |
          aws ecs update-service --cluster LaravelCluster --service LaravelService/Service --force-new-deployment 